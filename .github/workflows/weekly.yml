name: Weekly Market Digest

on:
  schedule:
    # Runs every Monday at 08:00 Thailand time (01:00 UTC)
    - cron: "0 1 * * 1"
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Download repository files
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install libraries
        run: |
          pip install -r requirements.txt

      - name: Check secrets exist (safe)
        run: |
          if [ -z "${TELEGRAM_BOT_TOKEN}" ]; then echo "TELEGRAM_BOT_TOKEN=EMPTY"; else echo "TELEGRAM_BOT_TOKEN=SET"; fi
          if [ -z "${TELEGRAM_CHAT_ID}" ]; then echo "TELEGRAM_CHAT_ID=EMPTY"; else echo "TELEGRAM_CHAT_ID=SET"; fi
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

      - name: Run bot
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python weekly_digest.py
